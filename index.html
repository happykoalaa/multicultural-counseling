<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>다문화 학생 상담 지원 프로그램</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            max-width: 800px;
            width: 100%;
            text-align: center;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #2d3436;
            margin-bottom: 40px;
            font-size: 2.5em;
        }

        h2 {
            color: #636e72;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        /* 교사 메뉴 버튼 */
        .teacher-menu-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .teacher-menu-btn:hover {
            background: #495057;
            transform: scale(1.05);
        }

        /* 언어 선택 화면 */
        .language-options {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .language-btn {
            background: white;
            border: 3px solid #ddd;
            border-radius: 20px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            min-width: 180px;
        }

        .language-btn:hover {
            transform: translateY(-10px);
            border-color: #74b9ff;
            box-shadow: 0 15px 40px rgba(116, 185, 255, 0.3);
        }

        .flag {
            width: 80px;
            height: 60px;
            margin: 0 auto 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            border: 2px solid #ddd;
            background: #f8f9fa;
        }

        .language-name {
            font-size: 18px;
            font-weight: bold;
            color: #2d3436;
        }

        /* 이름 선택 화면 */
        .name-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .name-btn {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border: none;
            border-radius: 15px;
            padding: 25px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            font-size: 18px;
            font-weight: bold;
            color: #495057;
        }

        .name-btn:hover {
            transform: translateY(-5px);
            background: linear-gradient(145deg, #74b9ff, #0984e3);
            color: white;
            box-shadow: 0 10px 25px rgba(116, 185, 255, 0.4);
        }

        .student-icon {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
        }

        /* 기분 선택 화면 */
        .mood-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin: 30px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .mood-btn {
            background: white;
            border: 3px solid #ddd;
            border-radius: 20px;
            padding: 20px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .mood-btn:hover {
            transform: scale(1.1);
            border-color: #74b9ff;
            box-shadow: 0 10px 25px rgba(116, 185, 255, 0.3);
        }

        .mood-emoji {
            font-size: 50px;
            margin-bottom: 10px;
            display: block;
        }

        .mood-text {
            font-size: 14px;
            font-weight: bold;
            color: #636e72;
        }

        /* 녹음 화면 */
        .recording-area {
            margin: 40px 0;
        }

        .record-btn {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(145deg, #ff6b6b, #ee5a52);
            color: white;
            font-size: 4em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.3);
            margin: 20px auto;
            display: block;
        }

        .record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 50px rgba(255, 107, 107, 0.4);
        }

        .record-btn.recording {
            background: linear-gradient(145deg, #00b894, #00a085);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .recording-status {
            font-size: 24px;
            margin: 20px 0;
            color: #636e72;
            min-height: 30px;
        }

        .recording-status.recording {
            color: #00b894;
            font-weight: bold;
        }

        .timer {
            font-size: 36px;
            font-weight: bold;
            color: #2d3436;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .controls {
            margin: 30px 0;
        }

        .btn {
            background: linear-gradient(145deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(116, 185, 255, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(116, 185, 255, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn.success {
            background: linear-gradient(145deg, #00b894, #00a085);
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
            font-size: 18px;
            padding: 20px 40px;
        }

        .btn.success:hover {
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.4);
        }

        .btn.back {
            background: linear-gradient(145deg, #636e72, #495057);
            box-shadow: 0 5px 15px rgba(99, 110, 114, 0.3);
        }

        .btn.back:hover {
            box-shadow: 0 8px 25px rgba(99, 110, 114, 0.4);
        }

        /* 완료 화면 */
        .completion-screen {
            text-align: center;
        }

        .completion-icon {
            font-size: 80px;
            margin: 20px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        .completion-message {
            font-size: 24px;
            color: #00b894;
            margin: 20px 0;
            font-weight: bold;
        }

        .completion-details {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #00b894;
        }

        /* 교사 화면 */
        .teacher-screen {
            max-width: 1000px;
            text-align: left;
        }

        .student-records {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }

        .record-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #74b9ff;
            transition: all 0.3s ease;
        }

        .record-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .student-info-short {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .student-name {
            font-size: 18px;
            font-weight: bold;
            color: #2d3436;
        }

        .student-mood {
            font-size: 16px;
            padding: 5px 12px;
            background: #f8f9fa;
            border-radius: 20px;
            border: 1px solid #dee2e6;
        }

        .record-date {
            font-size: 12px;
            color: #636e72;
        }

        .record-content {
            margin: 15px 0;
        }

        .content-label {
            font-size: 14px;
            font-weight: bold;
            color: #636e72;
            margin-bottom: 5px;
        }

        .content-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #495057;
            margin-bottom: 10px;
        }

        .record-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .mini-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .mini-btn.play {
            background: #17a2b8;
            color: white;
        }

        .mini-btn.delete {
            background: #dc3545;
            color: white;
        }

        .mini-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .no-records {
            text-align: center;
            padding: 40px;
            color: #636e72;
            font-style: italic;
        }

        .teacher-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .stats-summary {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(145deg, #e9ecef, #f8f9fa);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
        }

        .stat-label {
            font-size: 12px;
            color: #636e72;
            margin-top: 5px;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }

        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }

        .hidden { display: none; }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 2em; }
            h2 { font-size: 1.5em; }
            .language-options { gap: 20px; }
            .language-btn { min-width: 150px; padding: 20px 15px; }
            .record-btn { width: 120px; height: 120px; font-size: 3em; }
            .mood-options { grid-template-columns: repeat(3, 1fr); gap: 15px; }
            .student-info-short { flex-direction: column; gap: 8px; }
            .stats-summary { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 교사 메뉴 버튼 -->
        <button class="teacher-menu-btn" onclick="showTeacherScreen()">👨‍🏫 교사 화면</button>

        <!-- 1단계: 언어 선택 화면 -->
        <div id="languageScreen" class="screen active">
            <h1>🌍 언어를 선택해주세요</h1>
            <h2>Please choose your language</h2>
            
            <div class="language-options">
                <div class="language-btn" onclick="selectLanguage('ko')">
                    <div class="flag">🇰🇷</div>
                    <div class="language-name">한국어</div>
                </div>
                <div class="language-btn" onclick="selectLanguage('ru')">
                    <div class="flag">🇷🇺</div>
                    <div class="language-name">Русский</div>
                </div>
                <div class="language-btn" onclick="selectLanguage('vi')">
                    <div class="flag">🇻🇳</div>
                    <div class="language-name">Tiếng Việt</div>
                </div>
            </div>
        </div>

        <!-- 2단계: 이름 선택 화면 -->
        <div id="nameScreen" class="screen">
            <h1 id="nameTitle">👦 이름을 선택해주세요</h1>
            
            <div class="name-options">
                <button class="name-btn" onclick="selectName('리마크')">
                    <span class="student-icon">👦</span>
                    리마크
                </button>
                <button class="name-btn" onclick="selectName('누엔티성우')">
                    <span class="student-icon">👦</span>
                    누엔티성우
                </button>
                <button class="name-btn" onclick="selectName('정시율')">
                    <span class="student-icon">👦</span>
                    정시율
                </button>
                <button class="name-btn" onclick="selectName('조용원')">
                    <span class="student-icon">👦</span>
                    조용원
                </button>
            </div>
            
            <button class="btn back" onclick="goBack()">← 이전</button>
        </div>

        <!-- 3단계: 기분 선택 화면 -->
        <div id="moodScreen" class="screen">
            <h1 id="moodTitle">😊 오늘 기분은 어떤가요?</h1>
            
            <div class="mood-options">
                <div class="mood-btn" onclick="selectMood('매우 좋음', '😄')">
                    <span class="mood-emoji">😄</span>
                    <div class="mood-text" id="mood1">매우 좋음</div>
                </div>
                <div class="mood-btn" onclick="selectMood('좋음', '😊')">
                    <span class="mood-emoji">😊</span>
                    <div class="mood-text" id="mood2">좋음</div>
                </div>
                <div class="mood-btn" onclick="selectMood('보통', '😐')">
                    <span class="mood-emoji">😐</span>
                    <div class="mood-text" id="mood3">보통</div>
                </div>
                <div class="mood-btn" onclick="selectMood('슬픔', '😢')">
                    <span class="mood-emoji">😢</span>
                    <div class="mood-text" id="mood4">슬픔</div>
                </div>
                <div class="mood-btn" onclick="selectMood('화남', '😠')">
                    <span class="mood-emoji">😠</span>
                    <div class="mood-text" id="mood5">화남</div>
                </div>
                <div class="mood-btn" onclick="selectMood('무서움', '😨')">
                    <span class="mood-emoji">😨</span>
                    <div class="mood-text" id="mood6">무서움</div>
                </div>
            </div>
            
            <button class="btn back" onclick="goBack()">← 이전</button>
        </div>

        <!-- 4단계: 녹음 화면 -->
        <div id="recordingScreen" class="screen">
            <h1 id="recordTitle">🎤 이야기를 들려주세요</h1>
            
            <div id="messages"></div>
            
            <div class="recording-area">
                <button id="recordBtn" class="record-btn">🎤</button>
                <div id="recordingStatus" class="recording-status">마이크 버튼을 눌러 이야기해주세요</div>
                <div id="timer" class="timer">00:00</div>
            </div>
            
            <div class="controls">
                <button id="stopBtn" class="btn" disabled>정지</button>
                <button id="clearBtn" class="btn" disabled>다시 녹음</button>
                <button id="finishBtn" class="btn success hidden" onclick="autoSaveAndFinish()">✅ 이야기 완료</button>
                <button class="btn back" onclick="goBack()">← 이전</button>
            </div>
            
            <audio id="audioPlayer" controls class="hidden"></audio>
        </div>

        <!-- 5단계: 완료 화면 -->
        <div id="completionScreen" class="screen completion-screen">
            <div class="completion-icon">🎉</div>
            <h1>이야기를 들려줘서 고마워요!</h1>
            <div class="completion-message" id="completionMessage">
                선생님이 이야기를 확인해주실 거예요!
            </div>
            
            <div class="completion-details">
                <p><strong>이름:</strong> <span id="completionName">-</span></p>
                <p><strong>기분:</strong> <span id="completionMood">-</span></p>
                <p><strong>이야기 시간:</strong> <span id="completionDuration">-</span></p>
            </div>
            
            <button class="btn success" onclick="startNew()">🔄 새로운 이야기하기</button>
        </div>

        <!-- 교사 화면 -->
        <div id="teacherScreen" class="screen teacher-screen">
            <div class="teacher-header">
                <h1>👨‍🏫 교사 상담 기록</h1>
                <button class="btn" onclick="showStudentScreen()">🏠 학생 화면으로</button>
            </div>
            
            <div class="stats-summary">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">총 상담 건수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayRecords">0</div>
                    <div class="stat-label">오늘 상담</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="positiveRecords">0</div>
                    <div class="stat-label">긍정적 기분</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="needAttention">0</div>
                    <div class="stat-label">관심 필요</div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="refreshTeacherScreen()">🔄 새로고침</button>
                <button class="btn" onclick="exportRecords()">📄 기록 내보내기</button>
                <button class="btn back" onclick="clearAllRecords()">🗑️ 전체 삭제</button>
            </div>
            
            <div class="student-records" id="studentRecords">
                <div class="no-records">아직 상담 기록이 없습니다.</div>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentScreen = 1;
        let selectedLanguage = '';
        let selectedName = '';
        let selectedMood = '';
        let selectedMoodEmoji = '';
        let isTeacherMode = false;
        
        // 녹음 관련 변수
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let startTime = 0;
        let timerInterval = null;
        let currentAudioBlob = null;

        // 다국어 텍스트
        const texts = {
            ko: {
                nameTitle: '👦 이름을 선택해주세요',
                moodTitle: '😊 오늘 기분은 어떤가요?',
                recordTitle: '🎤 이야기를 들려주세요',
                mood1: '매우 좋음', mood2: '좋음', mood3: '보통',
                mood4: '슬픔', mood5: '화남', mood6: '무서움',
                recordingMsg: '마이크 버튼을 눌러 이야기해주세요',
                completionMsg: '선생님이 이야기를 확인해주실 거예요!'
            },
            ru: {
                nameTitle: '👦 Выберите ваше имя',
                moodTitle: '😊 Как ваше настроение сегодня?',
                recordTitle: '🎤 Расскажите вашу историю',
                mood1: 'Очень хорошо', mood2: 'Хорошо', mood3: 'Нормально',
                mood4: 'Грустно', mood5: 'Сердито', mood6: 'Страшно',
                recordingMsg: 'Нажмите на микрофон и расскажите',
                completionMsg: 'Учитель проверит вашу историю!'
            },
            vi: {
                nameTitle: '👦 Chọn tên của bạn',
                moodTitle: '😊 Hôm nay bạn cảm thấy thế nào?',
                recordTitle: '🎤 Hãy kể câu chuyện của bạn',
                mood1: 'Rất vui', mood2: 'Vui', mood3: 'Bình thường',
                mood4: 'Buồn', mood5: 'Giận', mood6: 'Sợ',
                recordingMsg: 'Nhấn nút mic và kể chuyện',
                completionMsg: 'Cô giáo sẽ kiểm tra câu chuyện của bạn!'
            }
        };

        // DOM 요소
        const recordBtn = document.getElementById('recordBtn');
        const recordingStatus = document.getElementById('recordingStatus');
        const timer = document.getElementById('timer');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const finishBtn = document.getElementById('finishBtn');
        const audioPlayer = document.getElementById('audioPlayer');
        const messages = document.getElementById('messages');

        // 언어 선택
        function selectLanguage(lang) {
            selectedLanguage = lang;
            updateTexts(lang);
            showScreen(2);
        }

        // 텍스트 업데이트
        function updateTexts(lang) {
            document.getElementById('nameTitle').textContent = texts[lang].nameTitle;
            document.getElementById('moodTitle').textContent = texts[lang].moodTitle;
            document.getElementById('recordTitle').textContent = texts[lang].recordTitle;
            document.getElementById('recordingStatus').textContent = texts[lang].recordingMsg;
            
            for (let i = 1; i <= 6; i++) {
                document.getElementById('mood' + i).textContent = texts[lang]['mood' + i];
            }
        }

        // 이름 선택
        function selectName(name) {
            selectedName = name;
            showScreen(3);
        }

        // 기분 선택
        function selectMood(mood, emoji) {
            selectedMood = mood;
            selectedMoodEmoji = emoji;
            showScreen(4);
        }

        // 화면 전환
        function showScreen(screenNum) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const screens = ['', 'languageScreen', 'nameScreen', 'moodScreen', 'recordingScreen', 'completionScreen', 'teacherScreen'];
            document.getElementById(screens[screenNum]).classList.add('active');
            currentScreen = screenNum;
        }

        // 교사 화면 표시
        function showTeacherScreen() {
            isTeacherMode = true;
            showScreen(6);
            loadTeacherData();
        }

        // 학생 화면으로 돌아가기
        function showStudentScreen() {
            isTeacherMode = false;
            startNew();
        }

        // 이전 화면
        function goBack() {
            if (currentScreen > 1 && !isTeacherMode) {
                showScreen(currentScreen - 1);
            }
        }

        // 메시지 표시
        function showMessage(text, type = 'info') {
            messages.innerHTML = `<div class="message ${type}">${text}</div>`;
        }

        function clearMessages() {
            messages.innerHTML = '';
        }

        // 타이머 기능
        function updateTimer() {
            if (isRecording) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // 녹음 기능
        recordBtn.addEventListener('click', async function() {
            if (!isRecording) {
                try {
                    clearMessages();
                    showMessage('마이크 권한을 요청하고 있습니다...', 'info');
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = function(event) {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = function() {
                        processRecording();
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start(1000);
                    isRecording = true;
                    
                    recordBtn.textContent = '⏹️';
                    recordBtn.classList.add('recording');
                    recordingStatus.textContent = '녹음 중... (다시 클릭하면 정지)';
                    recordingStatus.classList.add('recording');
                    stopBtn.disabled = false;
                    
                    startTimer();
                    showMessage('✅ 녹음이 시작되었습니다!', 'success');
                    
                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        showMessage('❌ 마이크 권한이 필요합니다!', 'error');
                    } else {
                        showMessage('❌ 마이크 오류: ' + error.message, 'error');
                    }
                }
            } else {
                stopRecording();
            }
        });

        stopBtn.addEventListener('click', stopRecording);

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                recordBtn.textContent = '🎤';
                recordBtn.classList.remove('recording');
                recordingStatus.textContent = '녹음이 완료되었습니다!';
                recordingStatus.classList.remove('recording');
                stopBtn.disabled = true;
                
                stopTimer();
            }
        }

        function processRecording() {
            if (audioChunks.length === 0) {
                showMessage('❌ 녹음된 데이터가 없습니다!', 'error');
                return;
            }

            try {
                currentAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(currentAudioBlob);
                
                audioPlayer.src = audioUrl;
                audioPlayer.classList.remove('hidden');
                clearBtn.disabled = false;
                finishBtn.classList.remove('hidden');

                showMessage(`🎉 녹음 완료! 이야기 완료 버튼을 눌러주세요!`, 'success');

            } catch (error) {
                showMessage('❌ 녹음 처리 오류: ' + error.message, 'error');
            }
        }

        clearBtn.addEventListener('click', function() {
            audioChunks = [];
            currentAudioBlob = null;
            audioPlayer.src = '';
            audioPlayer.classList.add('hidden');
            finishBtn.classList.add('hidden');
            timer.textContent = '00:00';
            recordingStatus.textContent = texts[selectedLanguage].recordingMsg;
            clearBtn.disabled = true;
            clearMessages();
        });

        // 자동 저장 및 완료
        function autoSaveAndFinish() {
            if (!currentAudioBlob) {
                showMessage('❌ 녹음된 파일이 없습니다!', 'error');
                return;
            }
            
            // 자동 저장
            saveStudentRecord();
            
            // 완료 화면으로 이동
            showCompletionScreen();
        }

        // 학생 기록 저장
        function saveStudentRecord() {
            try {
                const now = new Date();
                const record = {
                    id: now.getTime(),
                    name: selectedName,
                    language: selectedLanguage,
                    mood: selectedMood,
                    moodEmoji: selectedMoodEmoji,
                    date: now.toLocaleString('ko-KR'),
                    duration: timer.textContent,
                    originalText: generateSampleText(selectedLanguage),
                    translatedText: generateTranslatedText(selectedLanguage),
                    audioSize: (currentAudioBlob.size / 1024).toFixed(1) + 'KB',
                    needsAttention: ['슬픔', '화남', '무서움', 'Грустно', 'Сердито', 'Страшно', 'Buồn', 'Giận', 'Sợ'].includes(selectedMood)
                };
                
                // 기록 저장
                const existingRecords = JSON.parse(localStorage.getItem('counselingRecords') || '[]');
                existingRecords.push(record);
                localStorage.setItem('counselingRecords', JSON.stringify(existingRecords));
                
                // 음성 파일 저장
                if (currentAudioBlob) {
                    const reader = new FileReader();
                    reader.onload = function() {
                        const audioRecord = {
                            id: record.id,
                            name: selectedName,
                            date: record.date,
                            data: reader.result
                        };
                        
                        const existingAudio = JSON.parse(localStorage.getItem('counselingAudio') || '[]');
                        existingAudio.push(audioRecord);
                        localStorage.setItem('counselingAudio', JSON.stringify(existingAudio));
                    };
                    reader.readAsDataURL(currentAudioBlob);
                }
                
                console.log('✅ 학생 기록 자동 저장 완료');
                
            } catch (error) {
                console.error('❌ 저장 오류:', error);
            }
        }

        // 샘플 텍스트 생성 (실제로는 음성 인식 API 사용)
        function generateSampleText(lang) {
            const samples = {
                ko: '오늘 학교에서 친구들과 재미있게 놀았어요. 수학 시간이 조금 어려웠지만 선생님이 도와주셔서 좋았어요.',
                ru: 'Сегодня в школе я играл с друзьями. Урок математики был немного трудный, но учитель помог мне.',
                vi: 'Hôm nay ở trường tôi chơi với bạn bè rất vui. Tiết toán hơi khó nhưng cô giáo đã giúp tôi.'
            };
            return samples[lang] || samples['ko'];
        }

        // 번역 텍스트 생성 (실제로는 번역 API 사용)
        function generateTranslatedText(lang) {
            if (lang === 'ko') {
                return generateSampleText('ko');
            }
            
            const translations = {
                ru: '오늘 학교에서 친구들과 놀았습니다. 수학 수업이 조금 어려웠지만 선생님이 도와주었습니다.',
                vi: '오늘 학교에서 친구들과 재미있게 놀았습니다. 수학 시간이 조금 어려웠지만 선생님이 도와주셔서 좋았습니다.'
            };
            return translations[lang] || generateSampleText('ko');
        }

        // 완료 화면 표시
        function showCompletionScreen() {
            document.getElementById('completionName').textContent = selectedName;
            document.getElementById('completionMood').textContent = selectedMoodEmoji + ' ' + selectedMood;
            document.getElementById('completionDuration').textContent = timer.textContent;
            document.getElementById('completionMessage').textContent = texts[selectedLanguage].completionMsg;
            
            showScreen(5);
        }

        // 새로운 상담 시작
        function startNew() {
            // 변수 초기화
            selectedLanguage = '';
            selectedName = '';
            selectedMood = '';
            selectedMoodEmoji = '';
            isTeacherMode = false;
            
            // 녹음 관련 초기화
            audioChunks = [];
            currentAudioBlob = null;
            audioPlayer.src = '';
            audioPlayer.classList.add('hidden');
            finishBtn.classList.add('hidden');
            timer.textContent = '00:00';
            clearBtn.disabled = true;
            stopBtn.disabled = true;
            
            // 버튼 상태 초기화
            recordBtn.textContent = '🎤';
            recordBtn.classList.remove('recording');
            recordingStatus.classList.remove('recording');
            
            clearMessages();
            
            // 첫 화면으로 이동
            showScreen(1);
        }

        // 교사 화면 데이터 로드
        function loadTeacherData() {
            const records = JSON.parse(localStorage.getItem('counselingRecords') || '[]');
            
            // 통계 업데이트
            updateTeacherStats(records);
            
            // 기록 표시
            displayStudentRecords(records);
        }

        // 교사 통계 업데이트
        function updateTeacherStats(records) {
            const today = new Date().toDateString();
            const todayRecords = records.filter(r => new Date(r.date).toDateString() === today);
            const positiveRecords = records.filter(r => ['매우 좋음', '좋음', 'Очень хорошо', 'Хорошо', 'Rất vui', 'Vui'].includes(r.mood));
            const needAttention = records.filter(r => r.needsAttention);
            
            document.getElementById('totalRecords').textContent = records.length;
            document.getElementById('todayRecords').textContent = todayRecords.length;
            document.getElementById('positiveRecords').textContent = positiveRecords.length;
            document.getElementById('needAttention').textContent = needAttention.length;
        }

        // 학생 기록 표시
        function displayStudentRecords(records) {
            const container = document.getElementById('studentRecords');
            
            if (records.length === 0) {
                container.innerHTML = '<div class="no-records">아직 상담 기록이 없습니다.</div>';
                return;
            }
            
            // 최신 순으로 정렬
            records.sort((a, b) => b.id - a.id);
            
            container.innerHTML = '';
            
            records.forEach(record => {
                const cardClass = record.needsAttention ? 'record-card attention-needed' : 'record-card';
                const borderColor = record.needsAttention ? '#dc3545' : '#74b9ff';
                
                const recordCard = document.createElement('div');
                recordCard.className = cardClass;
                recordCard.style.borderLeftColor = borderColor;
                
                recordCard.innerHTML = `
                    <div class="record-header">
                        <div class="student-info-short">
                            <div class="student-name">${record.name}</div>
                            <div class="student-mood">${record.moodEmoji} ${record.mood}</div>
                            <div class="language-badge">${getLanguageName(record.language)}</div>
                        </div>
                        <div class="record-date">${record.date}</div>
                    </div>
                    
                    <div class="record-content">
                        <div class="content-label">원본 내용 (${getLanguageName(record.language)})</div>
                        <div class="content-text">${record.originalText}</div>
                        
                        <div class="content-label">한국어 번역</div>
                        <div class="content-text">${record.translatedText}</div>
                        
                        <div style="font-size: 12px; color: #636e72; margin-top: 10px;">
                            녹음 시간: ${record.duration} | 파일 크기: ${record.audioSize}
                        </div>
                    </div>
                    
                    <div class="record-actions">
                        <button class="mini-btn play" onclick="playStudentAudio(${record.id})">▶️ 재생</button>
                        <button class="mini-btn delete" onclick="deleteStudentRecord(${record.id})">🗑️ 삭제</button>
                    </div>
                `;
                
                container.appendChild(recordCard);
            });
        }

        function getLanguageName(code) {
            const names = { ko: '한국어', ru: '러시아어', vi: '베트남어' };
            return names[code] || code;
        }

        // 학생 음성 재생
        window.playStudentAudio = function(id) {
            try {
                const audioRecords = JSON.parse(localStorage.getItem('counselingAudio') || '[]');
                const audioRecord = audioRecords.find(r => r.id === id);
                
                if (audioRecord) {
                    const audio = new Audio(audioRecord.data);
                    audio.play();
                    
                    // 재생 상태 표시
                    const playBtn = event.target;
                    const originalText = playBtn.textContent;
                    playBtn.textContent = '⏸️ 재생중';
                    playBtn.disabled = true;
                    
                    audio.onended = function() {
                        playBtn.textContent = originalText;
                        playBtn.disabled = false;
                    };
                } else {
                    alert('음성 파일을 찾을 수 없습니다.');
                }
            } catch (error) {
                alert('재생 중 오류가 발생했습니다: ' + error.message);
            }
        };

        // 학생 기록 삭제
        window.deleteStudentRecord = function(id) {
            if (confirm('정말 이 기록을 삭제하시겠습니까?')) {
                try {
                    // 기록 삭제
                    const records = JSON.parse(localStorage.getItem('counselingRecords') || '[]');
                    const filteredRecords = records.filter(r => r.id !== id);
                    localStorage.setItem('counselingRecords', JSON.stringify(filteredRecords));
                    
                    // 음성 파일 삭제
                    const audioRecords = JSON.parse(localStorage.getItem('counselingAudio') || '[]');
                    const filteredAudio = audioRecords.filter(r => r.id !== id);
                    localStorage.setItem('counselingAudio', JSON.stringify(filteredAudio));
                    
                    // 화면 새로고침
                    loadTeacherData();
                    
                } catch (error) {
                    alert('삭제 중 오류가 발생했습니다: ' + error.message);
                }
            }
        };

        // 교사 화면 새로고침
        function refreshTeacherScreen() {
            loadTeacherData();
        }

        // 기록 내보내기 (CSV 형태)
        function exportRecords() {
            try {
                const records = JSON.parse(localStorage.getItem('counselingRecords') || '[]');
                
                if (records.length === 0) {
                    alert('내보낼 기록이 없습니다.');
                    return;
                }
                
                let csv = '날짜,이름,언어,기분,원본내용,한국어번역,녹음시간,관심필요\n';
                
                records.forEach(record => {
                    csv += `"${record.date}","${record.name}","${getLanguageName(record.language)}","${record.mood}","${record.originalText}","${record.translatedText}","${record.duration}","${record.needsAttention ? '예' : '아니오'}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `상담기록_${new Date().toLocaleDateString('ko-KR')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                alert('내보내기 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 전체 기록 삭제
        function clearAllRecords() {
            if (confirm('정말 모든 상담 기록을 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
                if (confirm('다시 한 번 확인합니다. 정말 모든 기록을 삭제하시겠습니까?')) {
                    localStorage.removeItem('counselingRecords');
                    localStorage.removeItem('counselingAudio');
                    loadTeacherData();
                    alert('✅ 모든 기록이 삭제되었습니다.');
                }
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', function() {
            console.log('다문화 학생 상담 프로그램 시작');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('❌ 이 브라우저는 음성 녹음을 지원하지 않습니다!');
            } else if (!window.isSecureContext) {
                alert('❌ HTTPS 환경이 필요합니다!');
            } else {
                console.log('✅ 모든 기능 준비 완료');
            }
        });

        // 키보드 단축키 (교사용)
        document.addEventListener('keydown', function(event) {
            if (isTeacherMode) {
                // Ctrl + R: 새로고침
                if (event.ctrlKey && event.key === 'r') {
                    event.preventDefault();
                    refreshTeacherScreen();
                }
                
                // Ctrl + E: 내보내기
                if (event.ctrlKey && event.key === 'e') {
                    event.preventDefault();
                    exportRecords();
                }
                
                // Ctrl + H: 도움말
                if (event.ctrlKey && event.key === 'h') {
                    event.preventDefault();
                    showTeacherHelp();
                }
            }
            
            // Ctrl + T: 교사 모드 토글
            if (event.ctrlKey && event.key === 't') {
                event.preventDefault();
                if (isTeacherMode) {
                    showStudentScreen();
                } else {
                    showTeacherScreen();
                }
            }
        });

        // 교사 도움말
        function showTeacherHelp() {
            alert(`
🎯 교사 화면 사용법:

📊 통계 카드:
• 총 상담 건수: 전체 상담 기록
• 오늘 상담: 오늘 날짜의 상담
• 긍정적 기분: 좋음/매우 좋음 선택 학생
• 관심 필요: 슬픔/화남/무서움 선택 학생

🎵 기록 카드:
• ▶️ 재생: 학생 음성 듣기
• 🗑️ 삭제: 해당 기록 삭제
• 빨간 테두리: 관심이 필요한 학생

⌨️ 키보드 단축키:
• Ctrl + T: 교사/학생 화면 전환
• Ctrl + R: 기록 새로고침
• Ctrl + E: CSV 파일로 내보내기
• Ctrl + H: 이 도움말 보기

💡 팁: 관심이 필요한 학생(슬픔, 화남, 무서움)은
빨간색 테두리로 표시됩니다.`);
        }
    </script>
</body>
</html>
